게임 데이터 넣을 거면 putitem대신 업데이트 하고 업데이트 한 부분만 익스프레션 빌드
goneerror 처리

웹소켓 클라이언트에 메시지 보낼때 다보내게되는데... 그냥 분리할까?

websocket단에서 현재 플레이어 인식? 아니면 큐 핸들러에서? -> 턴이 아니면 그냥 버려도 되잖아? 그럼노상관인데? 게임중아닐때도

userid 좀 킹받네

getitem 결과 없을때 처리


# MyWebSocketPermission:
  #   Type: AWS::Lambda::Permission
  #   Properties:
  #     Action: lambda:InvokeFunction
  #     FunctionName: !Ref MyWebSocketFunction
  #     Principal: apigateway.amazonaws.com
  #     SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${SimpleChatWebSocket}/authorizers/${MyWebSocketAuthorizer}
  
  # MyWebSocketRole:
  #   Type: AWS::IAM::Role
  #   Properties:
  #     AssumeRolePolicyDocument:
  #       Version": "2012-10-17"
  #       Statement:
  #         - Effect: Allow,
  #           Principal:
  #             Service:
  #               - apigateway.amazonaws.com
  #           Action: "sts:AssumeRole"
  #     Policies:
  #       - PolicyName: WebSocketInvokeLambda
  #         PolicyDocument:
  #           Version: "2012-10-17"
  #           Statement: 
  #             - Effect: Allow
  #               Action: "lambda:InvokeFunction"
  #               Resource: !GetAtt MyWebSocketFunction.Arn

  # MyWebSocketAuthorizer:
  #   Type: AWS::ApiGatewayV2::Authorizer
  #   Properties:
  #     ApiId: !Ref SimpleChatWebSocket
  #     AuthorizerType: REQUEST
  #     AuthorizerCredentialsArn: !GetAtt MyWebSocketRole.Arn
  #     Name: LambdaAuthorizer
  #     AuthorizerUri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${MyWebSocketFunction.Arn}/invocations
  #     IdentitySource:
  #       - route.request.header.Auth


    WebSocketConnectionDynamoDB:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: ConnectionId
          AttributeType: "S"
        - AttributeName: GameSessionId
          AttributeType: "S"
      KeySchema:
        - AttributeName: ConnectionId
          KeyType: "HASH"
      GlobalSecondaryIndexes:
        - IndexName: ByGameSessionId
          KeySchema:
            - AttributeName: GameSessionId
              KeyType: "HASH"
          Projection: 
            NonKeyAttributes: 
              - UserId
            ProjectionType: INCLUDE
      BillingMode: PAY_PER_REQUEST


	dbItem, _ := attributevalue.MarshalMap(game.WebSocketClient{
		ConnectionId:  req.RequestContext.ConnectionID,
		GameSessionId: gameSessionId,
		UserId:        "header-required",
	})
	_, err = dbClient.PutItem(ctx, &dynamodb.PutItemInput{
		TableName:           aws.String(os.Getenv("CONNECTION_DYNAMODB")),
		Item:                dbItem,
		ConditionExpression: aws.String("attribute_not_exists(id)"),
	})


disconnect
{Resource: 
Path: 
HTTPMethod: 
Headers:map[
    Host:omlo79fwk8.execute-api.us-east-1.amazonaws.com 
    X-Forwarded-For: 
    x-api-key: 
    x-restapi:
]
MultiValueHeaders:map[
    Host:[omlo79fwk8.execute-api.us-east-1.amazonaws.com] 
    X-Forwarded-For:[] 
    x-api-key:[] 
    x-restapi:[]
] 
QueryStringParameters:map[] 
MultiValueQueryStringParameters:map[] 
PathParameters:map[] 
StageVariables:map[] 
RequestContext:{
    AccountID: 
    ResourceID: 
    Stage:Dev 
    RequestID:V0IJFF-jIAMFmIQ= 
    Identity:{
        CognitoIdentityPoolID: 
        AccountID: 
        CognitoIdentityID: 
        Caller: 
        APIKey: 
        APIKeyID: 
        AccessKey: 
        SourceIP:220.70.42.35 
        CognitoAuthenticationType: 
        CognitoAuthenticationProvider: 
        UserArn: 
        UserAgent: 
        User:
    } 
    ResourcePath: 
    Authorizer:<nil> 
    HTTPMethod: 
    APIID:omlo79fwk8 
    ConnectedAt:1712424631834 
    ConnectionID:V0H8xfjDoAMCKFg= 
    DomainName:omlo79fwk8.execute-api.us-east-1.amazonaws.com 
    Error: 
    EventType:DISCONNECT 
    ExtendedRequestID:V0IJFF-jIAMFmIQ= 
    IntegrationLatency: 
    MessageDirection:IN 
    MessageID:<nil> 
    RequestTime:06/Apr/2024:17:31:50 +0000 
    RequestTimeEpoch:1712424710635 
    RouteKey:$disconnect 
    Status:
} 
Body: IsBase64Encoded:false}



websocket custom route
{
  "resource": "",
  "path": "",
  "headers": null,
  "multiValueHeaders": null,
  "queryStringParameters": null,
  "multiValueQueryStringParameters": null,
  "pathParameters": null,
  "stageVariables": null,
  "requestContext": {
    "accountId": "",
    "resourceId": "",
    "stage": "Dev",
    "requestId": "V3XXqGlhIAMFkww=",
    "identity": {
      "cognitoIdentityPoolId": "",
      "accountId": "",
      "cognitoIdentityId": "",
      "caller": "",
      "apiKey": "",
      "apiKeyId": "",
      "accessKey": "",
      "sourceIp": "220.70.42.35",
      "cognitoAuthenticationType": "",
      "cognitoAuthenticationProvider": "",
      "userArn": "",
      "userAgent": "",
      "user": ""
    },
    "resourcePath": "",
    "authorizer": null,
    "httpMethod": "",
    "apiId": "omlo79fwk8",
    "connectedAt": 1712509579334,
    "connectionId": "V3XV0cLFoAMCJAQ=",
    "domainName": "omlo79fwk8.execute-api.us-east-1.amazonaws.com",
    "error": "",
    "eventType": "MESSAGE",
    "extendedRequestId": "V3XXqGlhIAMFkww=",
    "integrationLatency": "",
    "messageDirection": "IN",
    "messageId": "V3XXqcP_oAMCJAQ=",
    "requestTime": "07/Apr/2024:17:06:31 +0000",
    "requestTimeEpoch": 1712509591122,
    "routeKey": "move",
    "status": ""
  },
  "body": "{\"action\":\"move\"}"
}